import{z as a,A as e,O as s,B as t,d as l,r as u,c as i,a as n,w as d,i as r,b as c,e as o,j as v,f,m as g,h as _,t as b,u as p,n as y,C as h,D as k,k as x,F as w,l as m,E as S,v as C,g as K,x as T}from"./index-FfUOk1pn.js";import{u as B,_ as N}from"./Fireworks.vue_vue_type_style_index_0_scoped_b6ed5fc5_lang.CDRSyFuc.js";import{u as F,d as j,e as M,g as z,N as E,a as I,T as O,h as L,j as P,k as R,l as J,m as U}from"./multisig.CtaWxO7N.js";const A=(s=>(l,u=a())=>{!t&&e(s,l,u)})(s),D=N(l({__name:"index",setup(a){const{t:e}=B(),{address:s,signMessage:t}=F(),l=u(null),N=u(!0),D=u(""),q=u(!1),G=u("");A(a=>{a.id?H(a.id):(D.value=e("toastNoId"),N.value=!1)});const H=async a=>{var s;try{l.value=await j.get(a),G.value=(null==(s=l.value)?void 0:s.broadcast_txid)||""}catch(t){console.error(t),D.value=e("toastLoadFailed")}finally{N.value=!1}},Q=i(()=>l.value?"neo-n3-testnet"===l.value.chain_id?e("chainTestnet"):e("chainMainnet"):""),V=i(()=>{if(!l.value)return[];try{const a=M(l.value.threshold,l.value.signers);return a.publicKeys.map(a=>({publicKey:a,address:z(a)}))}catch(a){return console.error(a),[]}}),W=i(()=>{var a;return Object.keys((null==(a=l.value)?void 0:a.signatures)||{}).length}),X=i(()=>l.value?Math.min(100,W.value/l.value.threshold*100):0),Y=i(()=>{var a;return W.value>=((null==(a=l.value)?void 0:a.threshold)||1)}),Z=i(()=>{var a;if(!l.value||!(null==s?void 0:s.value))return!1;const e=V.value.find(a=>a.address===s.value);return!!e&&!!(null==(a=l.value.signatures)?void 0:a[e.publicKey])}),$=()=>g({url:"/pages/index/index"}),aa=a=>{var e,s;return!!(null==(s=null==(e=l.value)?void 0:e.signatures)?void 0:s[a])},ea=a=>a?a.slice(0,6)+"..."+a.slice(-4):"",sa=a=>{S({data:a}),C({title:e("copied"),icon:"none"})},ta=a=>{switch(a){case"pending":return e("statusPending");case"ready":return e("statusReady");case"broadcasted":return e("statusBroadcasted");case"cancelled":return e("statusCancelled");case"expired":return e("statusExpired");default:return e("statusUnknown")}},la=async()=>{if(l.value){q.value=!0;try{const a=O.deserialize(l.value.transaction_hex),s=L(l.value.chain_id),u=a.getMessageForSigning(s),i=await t(u);if(!i||!i.publicKey||!i.data)return void C({title:e("toastSignFailed"),icon:"none"});const n=P(i.publicKey),d=String(i.data||"").replace(/^0x/i,"").toLowerCase();if(!l.value.signers.includes(n))return void C({title:e("toastNotSigner"),icon:"none"});if(!R(u,d,n))return void C({title:e("toastSignatureInvalid"),icon:"none"});const r=await j.addSignature(l.value.id,n,d);l.value=r,C({title:e("toastSignSuccess"),icon:"success"})}catch(a){console.error(a),C({title:e("toastSignFailed"),icon:"none"})}finally{q.value=!1}}},ua=async()=>{if(l.value){q.value=!0;try{if(!Y.value)return void C({title:e("toastNotEnoughSignatures"),icon:"none"});const a=O.deserialize(l.value.transaction_hex),s=J(l.value.chain_id);if(await s.getBlockCount()>=a.validUntilBlock)return await j.updateStatus(l.value.id,"expired"),l.value.status="expired",void C({title:e("toastExpired"),icon:"none"});const t=M(l.value.threshold,l.value.signers),u=t.publicKeys.map(a=>{var e,s;return null==(s=null==(e=l.value)?void 0:e.signatures)?void 0:s[a]}).filter(a=>!!a);if(u.length<l.value.threshold)return void C({title:e("toastNotEnoughSignatures"),icon:"none"});const i=U(t.script,u.slice(0,l.value.threshold));a.witnesses=[i];const n=await s.sendRawTransaction(a),d="string"==typeof n?n:a.hash();G.value=d;const r=await j.updateStatus(l.value.id,"broadcasted",d);l.value=r;const c=K("multisig_history")?JSON.parse(K("multisig_history")):[],o=c.findIndex(a=>{var e;return a.id===(null==(e=l.value)?void 0:e.id)});o>=0&&(c[o].status="broadcasted",T("multisig_history",JSON.stringify(c))),C({title:e("toastBroadcastSuccess"),icon:"success"})}catch(a){console.error(a),C({title:e("toastBroadcastFailed"),icon:"none"})}finally{q.value=!1}}};return(a,s)=>{const t=f,u=r,i=k;return c(),n(u,{class:"page-container"},{default:d(()=>[o(u,{class:"nav-header"},{default:d(()=>[o(t,{class:"back-btn",onClick:$},{default:d(()=>[_("â†")]),_:1}),o(u,{class:"nav-text"},{default:d(()=>[o(t,{class:"title"},{default:d(()=>[_(b(p(e)("signTitle")),1)]),_:1}),o(t,{class:"subtitle"},{default:d(()=>[_(b(p(e)("appSubtitle")),1)]),_:1})]),_:1})]),_:1}),N.value?(c(),n(u,{key:0,class:"loading"},{default:d(()=>[_(b(p(e)("loading")),1)]),_:1})):D.value?(c(),n(u,{key:1,class:"error"},{default:d(()=>[_(b(D.value),1)]),_:1})):l.value?(c(),n(u,{key:2,class:"content"},{default:d(()=>[o(p(E),{class:"status-card"},{default:d(()=>[o(u,{class:"status-row"},{default:d(()=>[o(t,{class:"status-label"},{default:d(()=>[_(b(p(e)("statusLabel")),1)]),_:1}),o(t,{class:y(["status-val",l.value.status])},{default:d(()=>[_(b(ta(l.value.status)),1)]),_:1},8,["class"])]),_:1}),o(u,{class:"progress-bar"},{default:d(()=>[o(u,{class:"progress-fill",style:h({width:X.value+"%"})},null,8,["style"])]),_:1}),o(t,{class:"progress-text"},{default:d(()=>[_(b(p(e)("signatureProgress",{count:W.value,total:l.value.threshold})),1)]),_:1})]),_:1}),o(p(E),{class:"details-card"},{default:d(()=>[o(t,{class:"card-title"},{default:d(()=>[_(b(p(e)("detailsTitle")),1)]),_:1}),o(u,{class:"detail-row"},{default:d(()=>[o(t,{class:"label"},{default:d(()=>[_(b(p(e)("detailId")),1)]),_:1}),o(t,{class:"value copy",onClick:s[0]||(s[0]=a=>sa(l.value.id))},{default:d(()=>[_(b(l.value.id)+" ("+b(p(e)("copy"))+")",1)]),_:1})]),_:1}),o(u,{class:"detail-row"},{default:d(()=>[o(t,{class:"label"},{default:d(()=>[_(b(p(e)("detailMemo")),1)]),_:1}),o(t,{class:"value"},{default:d(()=>[_(b(l.value.memo||p(e)("detailMemoNone")),1)]),_:1})]),_:1}),o(u,{class:"detail-row"},{default:d(()=>[o(t,{class:"label"},{default:d(()=>[_(b(p(e)("detailChain")),1)]),_:1}),o(t,{class:"value"},{default:d(()=>[_(b(Q.value),1)]),_:1})]),_:1}),o(u,{class:"raw-data"},{default:d(()=>[o(t,{class:"label"},{default:d(()=>[_(b(p(e)("detailRawTx")),1)]),_:1}),o(i,{class:"raw-input",value:l.value.transaction_hex,disabled:""},null,8,["value"])]),_:1})]),_:1}),o(p(E),{class:"signers-card"},{default:d(()=>[o(t,{class:"card-title"},{default:d(()=>[_(b(p(e)("signersTitle")),1)]),_:1}),o(u,{class:"signer-list"},{default:d(()=>[(c(!0),x(w,null,m(V.value,a=>(c(),n(u,{key:a.publicKey,class:"signer-row"},{default:d(()=>[o(u,{class:"signer-info"},{default:d(()=>[o(t,{class:"signer-key"},{default:d(()=>[_(b(ea(a.publicKey)),1)]),_:2},1024),o(t,{class:"signer-address"},{default:d(()=>[_(b(ea(a.address)),1)]),_:2},1024),aa(a.publicKey)?(c(),n(t,{key:0,class:"badge signed"},{default:d(()=>[_(b(p(e)("badgeSigned")),1)]),_:1})):(c(),n(t,{key:1,class:"badge pending"},{default:d(()=>[_(b(p(e)("badgePending")),1)]),_:1}))]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),o(u,{class:"actions"},{default:d(()=>[Y.value||Z.value?v("",!0):(c(),n(p(I),{key:0,variant:"primary",size:"lg",block:"",onClick:la,disabled:q.value},{default:d(()=>[_(b(q.value?p(e)("buttonSigning"):p(e)("buttonSign")),1)]),_:1},8,["disabled"])),Y.value&&"broadcasted"!==l.value.status?(c(),n(p(I),{key:1,variant:"success",size:"lg",block:"",onClick:ua,disabled:q.value},{default:d(()=>[_(b(q.value?p(e)("buttonBroadcasting"):p(e)("buttonBroadcast")),1)]),_:1},8,["disabled"])):v("",!0),G.value?(c(),n(u,{key:2,class:"broadcast-success"},{default:d(()=>[o(t,{class:"success-text"},{default:d(()=>[_(b(p(e)("broadcastedTitle")),1)]),_:1}),o(t,{class:"tx-id",onClick:s[1]||(s[1]=a=>sa(G.value))},{default:d(()=>[_(b(p(e)("broadcastedTxid"))+": "+b(G.value),1)]),_:1})]),_:1})):v("",!0)]),_:1})]),_:1})):v("",!0)]),_:1})}}}),[["__scopeId","data-v-b55b61ce"]]);export{D as default};
